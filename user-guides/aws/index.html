



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Website and documentation for symplegma project">
      
      
        <link rel="canonical" href="https://clusterfrak-dynamics.github.io/symplegma/user-guides/aws/">
      
      
        <meta name="author" content="ArchiFleKs">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.6">
    
    
      
        <title>AWS - Symplegma</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#deploying-on-aws" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://clusterfrak-dynamics.github.io/symplegma/" title="Symplegma" class="md-header-nav__button md-logo">
          
            <i class="md-icon">dashboard</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Symplegma
              </span>
              <span class="md-header-nav__topic">
                AWS
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/clusterfrak-dynamics/symplegma/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      clusterfrak-dynamics/symplegma
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Overview" class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="./" title="Documentation" class="md-tabs__link md-tabs__link--active">
          Documentation
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../roadmap/networking/" title="Roadmap" class="md-tabs__link">
          Roadmap
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://clusterfrak-dynamics.github.io/symplegma/" title="Symplegma" class="md-nav__button md-logo">
      
        <i class="md-icon">dashboard</i>
      
    </a>
    Symplegma
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/clusterfrak-dynamics/symplegma/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      clusterfrak-dynamics/symplegma
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" checked>
    
    <label class="md-nav__link" for="nav-2-1">
      User Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        User Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        AWS
      </label>
    
    <a href="./" title="AWS" class="md-nav__link md-nav__link--active">
      AWS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-and-terragrunt" title="Terraform and Terragrunt" class="md-nav__link">
    Terraform and Terragrunt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terragrunt-modules" title="Terragrunt modules" class="md-nav__link">
    Terragrunt modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terragrunt-variables" title="Terragrunt variables" class="md-nav__link">
    Terragrunt variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-infrastructure" title="Creating the infrastructure" class="md-nav__link">
    Creating the infrastructure
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-infrastructure" title="Customizing the infrastructure" class="md-nav__link">
    Customizing the infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-infrastructure" title="Initializing the infrastructure" class="md-nav__link">
    Initializing the infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-kubernetes-with-symplegma-playbooks" title="Deploying Kubernetes with symplegma playbooks" class="md-nav__link">
    Deploying Kubernetes with symplegma playbooks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-dynamic-inventory" title="AWS Dynamic inventory" class="md-nav__link">
    AWS Dynamic inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubernetes-deployment" title="Customizing Kubernetes deployment" class="md-nav__link">
    Customizing Kubernetes deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-playbooks-with-deployment-script" title="Running the playbooks with deployment script" class="md-nav__link">
    Running the playbooks with deployment script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-cluster-access" title="Testing cluster access" class="md-nav__link">
    Testing cluster access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-e2e-test-with-sonobuoy" title="Running E2E test with Sonobuoy" class="md-nav__link">
    Running E2E test with Sonobuoy
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Roadmap
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Roadmap
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../roadmap/networking/" title="Networking" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../roadmap/cri/" title="CRI" class="md-nav__link">
      CRI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../roadmap/etcd/" title="etcd" class="md-nav__link">
      etcd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../roadmap/kubeadm/" title="Kubeadm" class="md-nav__link">
      Kubeadm
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-and-terragrunt" title="Terraform and Terragrunt" class="md-nav__link">
    Terraform and Terragrunt
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#terragrunt-modules" title="Terragrunt modules" class="md-nav__link">
    Terragrunt modules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#terragrunt-variables" title="Terragrunt variables" class="md-nav__link">
    Terragrunt variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-infrastructure" title="Creating the infrastructure" class="md-nav__link">
    Creating the infrastructure
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-infrastructure" title="Customizing the infrastructure" class="md-nav__link">
    Customizing the infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-infrastructure" title="Initializing the infrastructure" class="md-nav__link">
    Initializing the infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-kubernetes-with-symplegma-playbooks" title="Deploying Kubernetes with symplegma playbooks" class="md-nav__link">
    Deploying Kubernetes with symplegma playbooks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-dynamic-inventory" title="AWS Dynamic inventory" class="md-nav__link">
    AWS Dynamic inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-kubernetes-deployment" title="Customizing Kubernetes deployment" class="md-nav__link">
    Customizing Kubernetes deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-playbooks-with-deployment-script" title="Running the playbooks with deployment script" class="md-nav__link">
    Running the playbooks with deployment script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-cluster-access" title="Testing cluster access" class="md-nav__link">
    Testing cluster access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-e2e-test-with-sonobuoy" title="Running E2E test with Sonobuoy" class="md-nav__link">
    Running E2E test with Sonobuoy
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/clusterfrak-dynamics/symplegma/edit/master/docs/user-guides/aws.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="deploying-on-aws">Deploying on AWS<a class="headerlink" href="#deploying-on-aws" title="Permanent link">&para;</a></h1>
<p>Symplegma supports AWS as a cloud provider.</p>
<h2 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h2>
<p><code class="codehilite">contrib/aws/</code> contains terraform file to deploy the following architecture. This is strongly opinionated and deploys the following architecture:</p>
<p><img alt="aws reference architecture" src="../../images/aws-infra-transparent.png" /></p>
<p>For now, each cluster has its own VPC, subnets, NAT etc. VPC module is included inside the symplegma module, this is subject to change in the future as PR are welcomed to make the possibilities evolved and split modules.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://www.terraform.io/intro/getting-started/install.html">Terraform</a></li>
<li><a href="https://github.com/gruntwork-io/terragrunt#install-terragrunt">Terragrunt</a></li>
<li><a href="https://docs.ansible.com/ansible/2.7/installation_guide/intro_installation.html">Ansible</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a></li>
</ul>
<p>Git clone Symplegma main repository:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/clusterfrak-dynamics/symplegma.git
</pre></div>

<p>Fetch the roles with <code class="codehilite">ansible-galaxy</code>:</p>
<div class="codehilite"><pre><span></span>ansible-galaxy install -r requirements.yml
</pre></div>

<h2 id="terraform-and-terragrunt">Terraform and Terragrunt<a class="headerlink" href="#terraform-and-terragrunt" title="Permanent link">&para;</a></h2>
<p>Terragrunt is used to enable multiple cluster and environments, also to enable remote state storage and locking with Terraform.</p>
<p>Terraform remote state is stored in an encrypted S3 bucket and state locking is done with AWS DynamoDB.</p>
<h3 id="terragrunt-modules">Terragrunt modules<a class="headerlink" href="#terragrunt-modules" title="Permanent link">&para;</a></h3>
<p>Symplegma is packaged in a <a href="https://github.com/gruntwork-io/terragrunt">Terragrunt module</a> available <a href="https://github.com/clusterfrak-dynamics/symplegma/tree/master/contrib/aws/terraform">here</a>.</p>
<h3 id="terragrunt-variables">Terragrunt variables<a class="headerlink" href="#terragrunt-variables" title="Permanent link">&para;</a></h3>
<p>Remote state specific variables:</p>
<div class="codehilite"><pre><span></span>terragrunt = {
  remote_state {
    backend = &quot;s3&quot;
    config {
      bucket         = &quot;symplegma-remote-state&quot;
      key            = &quot;<span class="cp">${</span><span class="n">path_relative_to_include</span><span class="p">()</span><span class="cp">}</span>&quot;
      region         = &quot;eu-west-1&quot;
      encrypt        = true
      dynamodb_table = &quot;symplegma-remote-state-lock&quot;
    }
  }
}
</pre></div>

<p>Cluster specific variables:</p>
<div class="codehilite"><pre><span></span>terragrunt = {
  include {
    path = &quot;<span class="cp">${</span><span class="n">find_in_parent_folders</span><span class="p">()</span><span class="cp">}</span>&quot;
  }

  terraform {
    source = &quot;github.com/clusterfrak-dynamics/symplegma.git//contrib/aws/terraform/modules/symplegma&quot;
  }
}

//
// [provider]
//
aws_region = &quot;eu-west-1&quot;

//
// [kubernetes]
//
cluster_name = &quot;symplegma&quot;

//
// [module][vpc]
//
vpc_name = &quot;symplegma&quot;
vpc_cidr = &quot;10.0.0.0/16&quot;
vpc_azs             = [&quot;eu-west-1a&quot;, &quot;eu-west-1b&quot;, &quot;eu-west-1c&quot;]
vpc_private_subnets = [&quot;10.0.1.0/24&quot;, &quot;10.0.2.0/24&quot;, &quot;10.0.3.0/24&quot;]
vpc_public_subnets  = [&quot;10.0.101.0/24&quot;, &quot;10.0.102.0/24&quot;, &quot;10.0.103.0/24&quot;]
vpc_enable_nat_gateway = true
vpc_enable_dns_hostnames = true
vpc_tags = {
    Environment = &quot;sample&quot;
}

//
// [module][bastion]
//
bastion_name = &quot;symplegma-bastion&quot;
bastion_ami = &quot;ami-00035f41c82244dab&quot;
bastion_instance_type = &quot;t2.small&quot;
bastion_key_name = &quot;klefevre-sorrow&quot;

bastion_tags = {
    Terraform = &quot;true&quot;
    Environment = &quot;sample&quot;
}

//
// [module][master_asg]
//
master_asg_ami = &quot;ami-099b2d1bdd27b4649&quot;
master_asg_root_volume_size = 50
master_asg_max_size = 3
master_asg_min_size = 3
master_asg_desired_capacity = 3
master_asg_instance_type = &quot;t3.large&quot;
master_asg_key_name = &quot;klefevre-sorrow&quot;
master_asg_tags = [
    {
      key                 = &quot;Environment&quot;
      value               = &quot;sample&quot;
      propagate_at_launch = true
    }
  ]

//
// [module][node_asg]
//
node_asg_ami = &quot;ami-099b2d1bdd27b4649&quot;
node_asg_root_volume_size = 50
node_asg_max_size = 2
node_asg_min_size = 2
node_asg_desired_capacity = 2
node_asg_instance_type = &quot;t3.large&quot;
node_asg_key_name = &quot;klefevre-sorrow&quot;
node_asg_tags = [
    {
      key                 = &quot;Environment&quot;
      value               = &quot;sample&quot;
      propagate_at_launch = true
    }
  ]

//
// [nlb]
//
kubernetes_api_lb_port = 443
kubernetes_api_tg_port = 6443
kubernetes_api_lb_tags = {
      Environment = &quot;sample&quot;
}
</pre></div>

<h2 id="creating-the-infrastructure">Creating the infrastructure<a class="headerlink" href="#creating-the-infrastructure" title="Permanent link">&para;</a></h2>
<p>To init a new AWS cluster, simply run <code class="codehilite">./scripts/init-aws.sh $CLUSTER_NAME</code></p>
<p>It will generate <code class="codehilite">inventory/aws/$CLUSTER_NAME</code> with the following directory structure:</p>
<div class="codehilite"><pre><span></span>sample
├── aws.py -&gt; ../../../contrib/aws/inventory/aws.py
├── extra_vars.yml
├── group_vars
│   └── all
│       └── all.yml
├── host_vars
├── symplegma-ansible.sh -&gt; ../../../contrib/aws/scripts/symplegma-ansible.sh
└── tf_module_symplegma
    └── terraform.tfvars
</pre></div>

<h3 id="customizing-the-infrastructure">Customizing the infrastructure<a class="headerlink" href="#customizing-the-infrastructure" title="Permanent link">&para;</a></h3>
<p>Terraform variable files come with sensible default for the <code class="codehilite">eu-west-1</code> region.</p>
<p>If you wish to change remote state configuration you can edit <code class="codehilite">$CLUSTER_NAME/terraform.tfvars</code></p>
<p>If you wish to customize the infrastructure you can edit <code class="codehilite">$CLUSTER_NAME/tf_module_symplegma/terraform.tfvars</code></p>
<p>One of the most important variable is <code class="codehilite">cluster_name</code> that allows you tu use AWS dynamic inventory with multiple cluster. We recommend this variables to be coherent throughout your files and equals to <code class="codehilite">$CLUSTER_NAME</code> defined earlier.</p>
<p>There is also a set of sensible default tags that you can customize such as <code class="codehilite">Environment</code> for example or add your own.</p>
<p>To avoid bloating the configuration files and unnecessary hard coded values, Terraform provider credentials are derived from your AWS SDK config. Make sure you are using the correct aws profile by setting your <code class="codehilite">AWS_PROFILE</code> environment variable.</p>
<h3 id="initializing-the-infrastructure">Initializing the infrastructure<a class="headerlink" href="#initializing-the-infrastructure" title="Permanent link">&para;</a></h3>
<p>Once everything is configured to your needs, just run:</p>
<div class="codehilite"><pre><span></span>terragrunt apply-all --terragrunt-source-update
</pre></div>

<p>Couples minute later you should see your instances spawning in your EC2 dashboard.</p>
<h2 id="deploying-kubernetes-with-symplegma-playbooks">Deploying Kubernetes with symplegma playbooks<a class="headerlink" href="#deploying-kubernetes-with-symplegma-playbooks" title="Permanent link">&para;</a></h2>
<h3 id="aws-dynamic-inventory">AWS Dynamic inventory<a class="headerlink" href="#aws-dynamic-inventory" title="Permanent link">&para;</a></h3>
<p>AWS dynamic inventory allows you to target a specific set of instances depending on the <code class="codehilite">$CLUSTER_NAME</code> you set earlier. You can configure the behavior of dynamic inventory by setting the following <code class="codehilite">ENV</code>:</p>
<ul>
<li><code class="codehilite">export SYMPLEGMA_CLUSTER=$CLUSTER_NAME</code> : Target only instances belonging to this cluster.</li>
<li><code class="codehilite">export SYMPLEGMA_AWS_REGION=eu-west-1</code> : AWS region where instances are targeted.</li>
</ul>
<p>To test the behavior of the dynamic inventory just run:</p>
<div class="codehilite"><pre><span></span>./inventory/aws/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/aws.py --list
</pre></div>

<p>It should only return a specific subset of your instances.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>These variables can be exported automatically when using the deployment script, but they can still be set manually for testing / manual deployment purposes.</p>
</div>
<h3 id="customizing-kubernetes-deployment">Customizing Kubernetes deployment<a class="headerlink" href="#customizing-kubernetes-deployment" title="Permanent link">&para;</a></h3>
<p>In the cluster folder, it is possible to edit Ansible variables:</p>
<ul>
<li><code class="codehilite">group_vars/all/all.yml</code>: contains default Ansible variables.</li>
</ul>
<div class="codehilite"><pre><span></span>---
ansible_ssh_user: core
ansible_python_interpreter: /opt/bin/python
ansible_ssh_common_args: <span class="s1">&#39;-o StrictHostKeyChecking=no -o ProxyCommand=&quot;ssh -o StrictHostKeyChecking=no -W %h:%p -q ubuntu@{{ ansible_ssh_bastion_host }}&quot;&#39;</span>
ansible_ssh_bastion_host: __BASTION_IP__

kubeadm_version: v1.12.1
kubernetes_version: v1.12.1
<span class="c1"># kubernetes_api_server_address: __NLB_HOSTNAME__</span>
<span class="c1"># kubernetes_api_server_port: __NLB_LISTENER_PORT__</span>

cni_plugin: <span class="s2">&quot;calico&quot;</span>

kubeadm_api_server_extra_args: <span class="o">{}</span>
kubeadm_controller_manager_extra_args: <span class="o">{}</span>
kubeadm_scheduler_extra_args: <span class="o">{}</span>
kubeadm_api_server_extra_volumes: <span class="o">{}</span>
kubeadm_controller_manager_extra_volumes: <span class="o">{}</span>
kubeadm_scheduler_extra_volumes: <span class="o">{}</span>
kubeadm_kubelet_extra_args: <span class="o">{}</span>

kubeadm_cluster_name: symplegma
<span class="c1"># kubeadm_etcd_image_image: &quot;k8s.gcr.io/etcd:3.2.18&quot;</span>
</pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code class="codehilite">ansible_ssh_bastion_host</code>, <code class="codehilite">kubernetes_api_server_address</code> and <code class="codehilite">kubernetes_api_server_port</code> can be automatically populated when using the deployment script but they can still be set manually for testing / manual deployment purposes.</p>
</div>
<ul>
<li><code class="codehilite">extra_vars</code>: contains AWS cloud provider specific variables that you can override.</li>
</ul>
<div class="codehilite"><pre><span></span>---
kubeadm_api_server_extra_args: <span class="p">|</span>
  cloud-provider: <span class="s2">&quot;aws&quot;</span>

kubeadm_controller_manager_extra_args: <span class="p">|</span>-
    cloud-provider: <span class="s2">&quot;aws&quot;</span>
    configure-cloud-routes: <span class="s2">&quot;false&quot;</span>

kubeadm_scheduler_extra_args: <span class="o">{}</span>
kubeadm_api_server_extra_volumes: <span class="o">{}</span>
kubeadm_controller_manager_extra_volumes: <span class="o">{}</span>
kubeadm_scheduler_extra_volumes: <span class="o">{}</span>
kubeadm_kubelet_extra_args: <span class="p">|</span>
  cloud-provider: <span class="s2">&quot;aws&quot;</span>

calico_mtu: <span class="m">8981</span>
calico_ipv4pool_ipip: <span class="s2">&quot;CrossSubnet&quot;</span>
calico_felix_ipip: <span class="s2">&quot;true&quot;</span>
</pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you need to override control plane or kubelet specific parameters do it in <code class="codehilite">extra_vars.yml</code> as it overrides all other variables previously defined as per <a href="https://docs.ansible.com/ansible/2.7/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">Ansible variables precedence documentantion</a></p>
</div>
<h3 id="running-the-playbooks-with-deployment-script">Running the playbooks with deployment script<a class="headerlink" href="#running-the-playbooks-with-deployment-script" title="Permanent link">&para;</a></h3>
<p>A simple (really, it cannot be simpler) deployment script can call Ansible and compute the necessary Terraform output for you:</p>
<div class="codehilite"><pre><span></span><span class="ch">#! /bin/sh</span>

<span class="nv">INVENTORY_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="nb">export</span> <span class="nv">SYMPLEGMA_CLUSTER</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all cluster_name <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span>
<span class="nb">export</span> <span class="nv">SYMPLEGMA_AWS_REGION</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all aws_region <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span>

ansible-playbook -i <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/aws.py symplegma-init.yml -b -v <span class="se">\</span>
  -e @<span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span>/extra_vars.yml <span class="se">\</span>
  -e <span class="nv">ansible_ssh_bastion_host</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all -module<span class="o">=</span>bastion public_ip <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
  -e <span class="nv">kubernetes_api_server_address</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all kubernetes_api_lb_dns_name <span class="m">2</span>&gt;/dev/null <span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
  -e <span class="nv">kubernetes_api_server_port</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">INVENTORY_DIR</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> terragrunt output-all kubernetes_api_lb_listener_port <span class="m">2</span>&gt;/dev/null<span class="k">)</span><span class="s2">&quot;</span>
</pre></div>

<p>From the root of the repository just run your cluster deployment script:</p>
<div class="codehilite"><pre><span></span>./inventory/aws/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/symplegma-ansible.sh
</pre></div>

<h3 id="testing-cluster-access">Testing cluster access<a class="headerlink" href="#testing-cluster-access" title="Permanent link">&para;</a></h3>
<p>When the deployment is over, <code class="codehilite">admin.conf</code> should be exported in <code class="codehilite">kubeconfig/$CLUSTER_NAME/admin.conf</code>. You should be able to call the Kubernetes API with <code class="codehilite">kubectl</code>:</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/kubeconfig/<span class="si">${</span><span class="nv">CLUSTER_NAME</span><span class="si">}</span>/admin.conf

kubectl get nodes

NAME                                       STATUS   ROLES    AGE     VERSION
ip-10-0-1-140.eu-west-1.compute.internal   Ready    &lt;none&gt;   2d22h   v1.12.1
ip-10-0-1-22.eu-west-1.compute.internal    Ready    master   2d22h   v1.12.1
ip-10-0-2-47.eu-west-1.compute.internal    Ready    &lt;none&gt;   2d22h   v1.12.1
ip-10-0-2-8.eu-west-1.compute.internal     Ready    master   2d22h   v1.12.1
ip-10-0-3-123.eu-west-1.compute.internal   Ready    master   2d22h   v1.12.1
</pre></div>

<h2 id="running-e2e-test-with-sonobuoy">Running E2E test with Sonobuoy<a class="headerlink" href="#running-e2e-test-with-sonobuoy" title="Permanent link">&para;</a></h2>
<p>If you want to test your cluster, you can use <a href="https://github.com/heptio/sonobuoy">Sonobuoy</a> which run the standard conformance testing suite on your cluster.</p>
<p>Go to <a href="https://scanner.heptio.com/">Sonobuoy scanner</a> and just follow the instructions, the test results should be available after &#8532;h.</p>
<p>EOD</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../.." title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Overview
              </span>
            </div>
          </a>
        
        
          <a href="../../roadmap/networking/" title="Networking" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Networking
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.5e60981f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>